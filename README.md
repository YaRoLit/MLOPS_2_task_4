# Четвертое практическое задание по MLOPS

**Выполнил магистрант Литаврин Я.И.**

## Описание проекта:

***ВНИМАНИЕ! Из файлов T-parser.py, sender.py удалены установочные данные API-токена Telegram, необходимы для работы приложения. Необходимо получить и указать свои данные для работы приложения.***

Целью проекта является предсказание активности участников в отслеживаемом чате Telegram на сутки вперед на основании зарегистрированной активности в предшествующий период времени.

Для отслеживания используется открытый общедоступный учебный чат магистратуры УрФУ [Флудилка](https://t.me/+KxlX36pb-3hjMjRi).

Визуализация результатов работы модели (предсказаний) представлена в открытом канале Telegram [Трекинг модели](https://t.me/timeline_prediction).

## Примерная блок-схема проекта:

![Image alt](https://github.com/YaRoLit/MLOPS_2_task_4/raw/main/.readme_img/diag.png)

## Описание работы проекта:

Для работы проекта используется:
- менеджер процессов Airflow для конвейеризации и управления потоком операций,
- фреймворк хранения данных DVC для версионирования и сохранения результатов работы конвейера,
- платформа отображения экспериментов машинного обучения ClearML для сохранения и визуализации параметров модели и результатов ее работы,
- Телегам-чат [Трекинг модели](https://t.me/timeline_prediction) для ежесуточной визуализации графиков предсказанных и реально зафиксированных данных о пользовательской активности.
- В качестве модели машинного обучения используется sktime.forecasting.compose.make_reduction + sklearn.neighbors.KNeighborsRegressor.

В менеджере Airflow создано два графа операций.

Первый граф представляет собой конвейер ежесуточного сбора данных и работы с моделью. Он запускается по расписанию в 00:01:00 и осуществляет последовательность операций:
1. "Вытягивание" последних версий сохранненных файлов из DVC (dvc pull). 
2. Парсинг новой выборки сообщений, которые участники чата отправили в течение предыдущих суток;
3. Чтение файла с историей сообщений за весь период, добавление нового фрейма сообщений, полученных на предыдущем шаге, запись обновленного файла с историей.
4. Преобразование обновленного файла с историей сообщений в формат временного ряда (дата_час -- количество собщений), запись в виде отдельного файла.
5. Выбор из преобразованного временного ряда фрагмента пользовательской активности за предыдущие сутки и сравнение с предсказанием модели на этот период.
6. Запись полученной метрики sMAPE в ClearML.
7. Переобучение модели на обновленном временном ряду, сохранение.
8. Прогноз активности участников чата на грядущие сутки, запись в файл и на платформу ClearML.
9. Сохранение визуализаций временных рядов (предсказанного и реального значений) в виде графических файлов.
10. Сохранение всех файлов, созданных и (или) обновленных в ходе работы конвейера в репозитории DVC (dvc commit && dvc pull).

Второй граф предназначен для ежесуточного трекинга работы модели в специально созданном для этого Телеграм-чате [Трекинг модели](https://t.me/timeline_prediction). Он стартует ежесуточно в 09:00:00 и выполняет следующие действия:
1. "Вытягивает" последние версии сохранненных файлов из DVC (dvc pull).
2. Отправляет в вышеуказанный чат два графика, на которых отражены реальное количество сообщений в чате за предыдущие сутки (с почасовой разбивкой) и предсказание модели на будущие сутки. Таким образом при просмотре диаграмм в чате можно сравнить разницу между предсказанными и реальными значениями визуально.
3. Отправляет ссылку на страницу проекта MLOPS_task_4 на платформе ClearML, где авторизованные участники могут ознакомиться с другими параметрами эксперимента.
